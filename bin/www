#!/usr/bin/env node
var _ = require('underscore')._,
    app = require('../app'),
    redis = require('redis');

// database setup

var db = redis.createClient();
db.on('error', function(err) {
  console.log("Error: " + err);
});

app.locals.db = db;
if(_.has(process.env, 'DB')) {
  db.select(process.env.DB);
}

// server setup

var port = process.env.PORT || 3067;
var server = app.listen(port, function() {
  console.log('Express server listening on port ' + server.address().port);
});

// signal handler for clean shutdown

var shutdown = function() {
  console.log("\b\bShutting down..");
  server.close(function() {
    db.quit();
  });
  process.exit(0);
}

process.on('SIGINT', shutdown);
process.on('SIGTERM', shutdown);
