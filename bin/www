#!/usr/bin/env node
var _ = require('underscore')._,
		fs = require('fs'),
    http = require('http'),
    https = require('https'),
    app = require('../app');

// server setup

var port = process.env.PORT || 3070;

var server;
if(_.has(process.env, 'ALSUTI_TLS') &&
   process.env.ALSUTI_TLS == 'yes' &&
   _.has(process.env, 'ALSUTI_TLS_KEY') &&
   _.has(process.env, 'ALSUTI_TLS_CERT'))
{
  var options = {
    key: fs.readFileSync(process.env.ALSUTI_TLS_KEY).toString(),
    cert: fs.readFileSync(process.env.ALSUTI_TLS_CERT).toString()
  };

  server = https.createServer(options, app).listen(port);
}
else {
  server = http.createServer(app).listen(port);
}

// signal handling for clean shutdown

var shutdown = function() {
  console.log("\b\bShutting down..");
  server.close(function() {
    app.get('database').quit();
  });
  process.exit(0);
}

process.on('SIGINT', shutdown);
process.on('SIGTERM', shutdown);
